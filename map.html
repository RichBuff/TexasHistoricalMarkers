<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, height=device-height" />
        <title>
            Texas Historical Markers
        </title>
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
        <link rel="stylesheet" href="map.css" />
        <style>
            #mapcontainer {
            width: 98%;
            height: 400px;
            border:3px solid #eaeaea;
            }
        </style>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
        <script src="http://www.google.com/jsapi"></script>
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" charset="utf-8" src="cordova-1.8.1.js"></script>
        <script type="text/javascript" src="modernizr.js"></script>
        <script type="text/javascript">
            //key = AIzaSyDChATNeEQd-3gGliBQLdLkUQZH-Fjo_dc
            var map = null;
<<<<<<< HEAD
=======
            var marker = null;
>>>>>>> Fix Duplicate User Location Markers

            var image = new google.maps.MarkerImage('images/thc_logo.png');
            var shadow = new google.maps.MarkerImage(
                            'images/thc_shadow.png',
                            new google.maps.Size(37, 32),
                            new google.maps.Point(0,0),
                            new google.maps.Point(0, 32));

            $().ready(function(){

                // size the map div
                var viewPortHeight = $(window).height();
                var headerHeight = $('div[data-role="header"]').height();
                var footerHeight = $('div[data-role="footer"]').height();
                var contentHeight = viewPortHeight - headerHeight - footerHeight;

                // Set all pages with class="page-content" to be at least contentHeight
                $('#mapcontainer').css({'min-height': contentHeight + 'px'});

                $("#partial-content").ajaxError(function(e, jqxhr, settings, exception) {
                    debugger;
                    $(this).text( "Error requesting page " + settings.url);
                });

                if ( Modernizr.geolocation ) {
                    //navigator.geolocation.getCurrentPosition(getLocationHandler);
                    startWatch();
                }
                else{
                    alert("Error");
                    // todo: better error handling
                }
            });

            function watchErrorHandler(error){
                debugger;
                alert("Watch location error")
            }

            function watchPositionHandler(pos) {

                var coords = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
<<<<<<< HEAD
            debugger;

            if (map == null) {
=======

                if (map == null) {
>>>>>>> Fix Duplicate User Location Markers
                    var mapOptions = {
                        //zoom level, between 0 to 21.
                        zoom: 12,
                        //center to the user location
                        center: coords,
                        //add map type controls.
                        mapTypeControl: true,
                        navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    // Create the map, and place it in the mapContainer div
                    map = new google.maps.Map(document.getElementById("mapcontainer"), mapOptions);
                }

<<<<<<< HEAD
                // Place the initial marker
                var marker = new google.maps.Marker({
                    position: coords,
                    map: map,
                    title: "Your current location"
                });

            /******************/
                // Place the initial marker
                var marker = new google.maps.Marker({
=======
                if (marker != null) {
                    marker.setMap(null);
                    marker = null;
                }

                marker = new google.maps.Marker({
>>>>>>> Fix Duplicate User Location Markers
                    position: coords,
                    map: map,
                    title: "Your current location"
                });

                getHistoricalMarkers(pos.coords.latitude, pos.coords.longitude);
            }

            function getLocationHandler(pos) {
                $("#lat_field").val(pos.coords.latitude);
                $("#long_field").val(pos.coords.longitude);

                var coords = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                var mapOptions = {
                    //zoom level, between 0 to 21.
                    zoom: 12,
                    //center to the user location
                    center: coords,
                    //add map type controls.
                    mapTypeControl: true,
                    navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                // Create the map, and place it in the mapContainer div
                map = new google.maps.Map(document.getElementById("mapcontainer"), mapOptions);
                // Place the initial marker
                var marker = new google.maps.Marker({
                    position: coords,
                    map: map,
                    title: "Your current location"
                });

                getHistoricalMarkers(pos.coords.latitude, pos.coords.longitude);
                setTimeout(startWatch, 15000);
            }

            function getHistoricalMarkers(lat, lng){
//                var url = "http://fineglasswork.com/histmarkers/index2.php"; // ?lat=30.3165907&lng=-97.6766992&miles=6&callback=jp";
                $.ajax({
                    type: 'GET',
                    url: "http://fineglasswork.com/histmarkers/index2.php",
                    contentType: "application/json",
                    dataType: 'jsonp',
                    data: {lat: lat , lng: lng, miles:6 },
                    crossDomain: true,
                    success: function(markers) {
                        if (markers != null && markers.length > 0){
                            for (i=0; i < markers.length; i++){
                                addMarker(markers[i]);
                            }
                        }
                    },
                    error: function(e) {
                        alert("fail!");
                    },
                    complete: function(data) {
                        console.log(e.message);
                    }
                });
            }

            function addMarker(markerData){
                var coords = new google.maps.LatLng(markerData.Latitude, markerData.Longitude);

                var marker = new google.maps.Marker({
                position: coords,
                map: map,
                icon: image,
                shadow: shadow,
                title: markerData.title
            });

            marker.setValues({
                info : markerData
                });
                var evListener = google.maps.event.addListener(marker, 'click', function() {
                var myInfo = this.info;
                var contentString = "<div class='info-text'>"+
                "<table>" +
                    "<tr>" +
                        "<td>Address:</td>" +
                        "<td>"+myInfo.loc_desc + "<br/>" + myInfo.city +"</td>" +
                        "</tr>" +
                    "</table>" +
                "<br />" +
                "<div>Description: " + myInfo.description + "</div>" +
                "</div>";

                var infowindow = new google.maps.InfoWindow({
                    content: contentString
                });
                    infowindow.open(this.map, this);
                });
            }

            function startWatch(){
                navigator.geolocation.watchPosition(watchPositionHandler,watchErrorHandler,{
//                    timeout: (90000),
                    maximumAge: (1000 * 60 * 15),
                    enableHighAccuracy: true
                    });
            }
        </script>

    </head>
    <body>
        <!-- Home -->
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>
                    Texas Historical Markers
                </h3>
            </div>
            <div id="partial-content" style="border: 1px solid blue;">
            </div>
            <div data-role="content" style="padding: 15px" id="mapcontainer">
            </div>
        </div>
    </body>
</html>
